<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="\public\reset.css">
    <link rel="stylesheet" href="\public\put.css">
    <link rel="stylesheet" href="\public\indexstyle.css"> 
    <link rel="stylesheet" href="\public\mainstyle.css"> 
	<link rel="stylesheet" href="\public\canvas.css">
    <link rel="stylesheet" href="\public\comments.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  
    <title>ê°•ì˜ì‹¤</title>
</head>
<body>
    <script  src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>   
    <!-- <script  src="/socket.io/socket.io.js" >  </script> -->
   <!-- peerjs socket io ë¶ˆëŸ¬ì˜¤ê¸° -->
  
    <script  src="https://code.jquery.com/jquery-3.6.0.min.js"> </script>
    <script src="https://cdn.socket.io/4.5.2/socket.io.min.js" integrity="sha384-WPFUvHkB1aHA5TDSZi6xtDgkF0wXJcIIxXhC6h8OT8EH3fC5PWro5pWJ1THjcfEi" crossorigin="anonymous"></script>    
    <!-- <script  src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.js" integrity="sha512-9mpsATI0KClwt+xVZfbcf2lJ8IFBAwsubJ6mI3rtULwyM3fBmQFzj0It4tGqxLOGQwGfJdk/G+fANnxfq9/cew==" crossorigin="anonymous" referrerpolicy="no-referrer"></script> -->
    <script  src="https://unpkg.com/default-passive-events"></script>
    
    

    <button style="width: 10%; float: right; margin-right: 1%;" id="mute">ë§ˆì´í¬ ë„ê¸°</button> 
    <button style="width: 10%; float: right; margin-right: 1%;" id="startButton"  disabled>í™”ë©´ ê³µìœ </button> 
    <br>
    <br>
    <div id="cv" style="margin-top: 10px;"><!-- ê°•ì˜ìê°€ íŒì„œí•  ìº”ë²„ìŠ¤ì™€ ê·¸ë¦¬ê¸° ë„êµ¬--> 
        <div class="container">
            <section class="tools-board" >
              <div class="row"><!-- ë„í˜• ì˜µì…˜-->
                <label class="title">Shapes</label>
                <ul class="options">
                  <li class="option tool" id="rectangle">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16.301" height="16.301" viewBox="0 0 16.301 16.301">
                        <path id="square-regular" d="M13.972,32A2.33,2.33,0,0,1,16.3,34.329V45.972A2.331,2.331,0,0,1,13.972,48.3H2.329A2.33,2.33,0,0,1,0,45.972V34.329A2.329,2.329,0,0,1,2.329,32Zm0,1.747H2.329a.582.582,0,0,0-.582.582V45.972a.583.583,0,0,0,.582.582H13.972a.584.584,0,0,0,.582-.582V34.329A.583.583,0,0,0,13.972,33.747Z" transform="translate(0 -32)" fill="#5a6168"/>
                      </svg><!-- ì‚¬ê°í˜• ì•„ì´ì½˜ --> 
                       
                    <span></span>
                  </li>
                  <li class="option tool" id="circle">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16.301" height="16.301" viewBox="0 0 16.301 16.301">
                        <path id="circle-regular" d="M16.3,8.15A8.15,8.15,0,1,1,8.15,0,8.15,8.15,0,0,1,16.3,8.15ZM8.15,1.528A6.622,6.622,0,1,0,14.773,8.15,6.621,6.621,0,0,0,8.15,1.528Z" fill="#5a6168"/>
                      </svg> <!-- ì› ì•„ì´ì½˜ --> 
                      
                    <span></span>
                  </li>
                  <li class="option tool" id="triangle">
                    <svg xmlns="http://www.w3.org/2000/svg" width="17.874" height="15.711" viewBox="0 0 17.874 15.711">
                        <path id="triangle" d="M19.75,17.574,11.71,3.656a.893.893,0,0,0-1.554,0L2.116,17.574a.893.893,0,0,0,.777,1.34h16.08a.893.893,0,0,0,.777-1.34ZM4.438,17.127,10.933,5.889l6.495,11.238Z" transform="translate(-1.996 -3.203)" fill="#5a6168"/>
                      </svg><!-- ì‚¼ê°í˜• ì•„ì´ì½˜ --> 
                        
                    <span></span>
                  </li>
                  <li class="option">
                    <input type="checkbox" id="fill-color"><!-- ìƒ‰ ì±„ìš°ê¸° --> 
                    <label for="fill-color" >Fill color</label>
                  </li>
                </ul>
              </div>
              <div class="row">
                <label class="title">Options</label> <!-- ê·¸ë¦¬ê¸°,ì§€ìš°ê¸° ì„ íƒ ì˜µì…˜-->
                <ul class="options">
                  <li class="option active tool" id="brush">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14.445" height="14.462" viewBox="0 0 14.445 14.462">
                        <path id="Path_153" data-name="Path 153" d="M8.319,8.378l6.014-6.535a.4.4,0,0,0-.024-.577L13.155.111a.4.4,0,0,0-.553,0L6.066,6.125a.4.4,0,0,0,0,.577L7.742,8.378a.4.4,0,0,0,.577,0Zm-3.44-.89,2.093,2.1a.8.8,0,0,1,.249.457v.393a3.208,3.208,0,0,1-.938,2.277,6.223,6.223,0,0,1-4.739,1.732,2.326,2.326,0,0,1-1.427-.481.4.4,0,0,1-.048-.505,4.772,4.772,0,0,0,.714-2.609A3.626,3.626,0,0,1,1.744,8.17a3.208,3.208,0,0,1,2.269-.938,3.134,3.134,0,0,1,.393,0A.874.874,0,0,1,4.879,7.488Z" fill="#5a6168" fill-rule="evenodd"/>
                      </svg> 
                    <span></span>
                  </li>
                  <li class="option tool" id="eraser">
                    <svg xmlns="http://www.w3.org/2000/svg" width="17.093" height="16.301" viewBox="0 0 17.093 16.301">
                        <path id="bx-eraser" d="M2.543,14.46l3.985,3.985a.923.923,0,0,0,.655.272H18.309V16.862h-6.45l6.695-6.695a1.855,1.855,0,0,0,0-2.622l-4.59-4.589a1.857,1.857,0,0,0-2.622,0l-4.4,4.4L2.532,11.849a1.86,1.86,0,0,0,.011,2.61ZM12.653,4.268l4.589,4.589-2.4,2.4L10.256,6.665l2.4-2.4Zm-4.4,4.4.689-.688,4.589,4.589L9.31,16.789a.951.951,0,0,0-.064.073H7.568L3.855,13.148l4.4-4.484Z" transform="translate(-2.003 -2.416)" fill="#5a6168"/>
                      </svg> 
                      
                    <span></span>
                  </li>
                  <li class="option">
                    <input type="range" id="size-slider" min="1" max="30" value="5">
                  </li>
                </ul>
              </div>
              <div class="row colors"><!-- ìƒ‰ ì˜µì…˜-->
                <label class="title">Colors</label>
                <ul class="options">
                  <li class="option"></li>
                  <li class="option selected"></li>
                  <li class="option"></li>
               
                  <li class="option">
                    <input type="color" id="color-picker" value="#4A98F7">
                  </li>
                </ul>
              </div>
              <div class="row buttons"><!-- ëª¨ë‘ ì§€ìš°ê¸° -->
                <button class="clear-canvas">Clear</button>
             
              </div>
            </section>
            <section class="drawing-board">
              <canvas id='a' width="1150px" height="550vh"></canvas>
              <script src="\public\drawing.js"></script><!-- ìº”ë²„ìŠ¤ ê·¸ë¦¬ê¸° ì˜µì…˜ë“¤ ì‹¤í–‰ js -->
            </section>

            <div class="servetext2"style="float: right; margin-top:2%; margin-right:10px">
   
                <div id="count" >ì¹´ìš´íŠ¸</div>
                <hr size="5" width="150px" noshade>
                <div>ê°•ì˜ì: <%=ê°•ì˜ì%></div>
                
                <hr size="5" width="150px" noshade>
                <div >ì°¸ì—¬ì ë¦¬ìŠ¤íŠ¸</div>
                <hr size="5" width="150px" noshade>    
                <div id="list"></div>  <!-- ì›¹ ì†Œì¼“ì—ì„œ ë¶ˆëŸ¬ì˜¨ ì ‘ì†ì ëª©ë¡  -->     
               </div>
          </div>


    </div>

    

    <video id="video" style="margin-bottom: 1%; border: 1px solid black;" width="1150px" height="550vh" autoplay></video>
    <!-- ìº¡í¼ìŠ¤ ìº¡ì²˜ ìŠ¤íŠ¸ë¦¼ ì €ì¥-->         
    <video id="peersvideo" style="margin-bottom: 1%; border: 1px solid black; margin-left: 16px;" width="1150px" height="550vh" autoplay></video> 
    <!-- ê°•ì˜ìì˜ íŒì„œë¥¼ ìˆ˜ê°•ì í™”ë©´ì— ë³´ì—¬ì¤„ ë¹„ë””ì˜¤ -->
    <video id='sharevideo' style="margin-top: 2%; border: 1px solid black;" width="1150px" height="550vh" autoplay></video>
    <!-- í™”ë©´ ê³µìœ -->

    <div class="servetext2" id='listuser' style="float: right; margin-top:2%; margin-right:10px"> <!-- ìˆ˜ê°•ì í™”ë©´ì— ë³´ì—¬ì¤„ ëª©ë¡ ìœ„ì¹˜-->
    <div id="count1" >ì¹´ìš´íŠ¸</div>
    <hr size="5" width="150px" noshade>
    <div>ê°•ì˜ì: <%=ê°•ì˜ì%></div>
    
    <hr size="5" width="150px" noshade>
    <div >ì°¸ì—¬ì ë¦¬ìŠ¤íŠ¸</div>
    <hr size="5" width="150px" noshade>    
    <div id="list1"></div>       
   </div>

<!-- ì±„íŒ…ì°½ -->
    <div id="chatbox" style=" float:left; width:50%; height: 10vh; overflow: auto; white-space: nowrap; border: 1.2px solid black; margin-left: 16px;">
        <div id="chat"></div>       
    </div>   

    <input type="text" id="msg" style="width: 50%; padding: 5px; margin-left: 16px; "required>
    <button class="btn2" id="send" style="width: 10%; ">ì±„íŒ…í•˜ê¸°</button>       

<!--ì†ë“¤ê¸°, ë¬¸ì œì‚¬ì§„ ë³´ê¸° ì•„ì´ì½˜-->    
    <i class="fa fa-file-image-o" data-icon="img" style="float:right; margin-right: 3%;font-size: 38px;color: #547ef89e;cursor: pointer; width: 50px;height: 45px;text-align: center;"></i>
    <div id="hand" style="float:right; margin-right: 3%;">
    <i class="fa fa-hand-paper-o" data-icon="noti" style="font-size: 38px;color: #547ef89e;cursor: pointer; width: 50px;height: 45px;text-align: center;"></i>    
    </div>
    
 
<!--í•™ìŠµì¢…ë£Œ ë²„íŠ¼(ê°•ì˜ìì—ê²Œë§Œ ë³´ì„)-->      
    <form action="/done" method="post">
        <input type="hidden" id='number' name='postnum' value="<%=ê¸€ë²ˆí˜¸%>">
        <button type="submit" id="exitbtn" onclick="javascript:exitmg()" style=" float:left; background-color: #4657d3;color: white;padding: 5px 10px;margin: 8px 0;border: none;cursor: pointer;width: 100%;" >ìˆ˜ì—… ì¢…ë£Œí•˜ê¸°</button>      
    </form>

<!--ì†ë“¤ê¸° ì•Œë¦¼ì°½-->    
    <div class="notification-container" id="notification-container">
        
    </div>

<!--ì ‘ì†í•œ ì‚¬ëŒë“¤ ìŒì„±ì €ì¥-->       
    <div id="myStreamv">
       
    </div>

<!--ë¬¸ì œì‚¬ì§„ ëª¨ë‹¬-->    
    <div id="tu01" class="modal" >
        <form class="modal-content animate" action="123" method="post">
           
          <div class="container" style="background-color:#f1f1f1">
            
            <img class="modal-target" alt="Img 1" src="<%=ì´ë¯¸ì§€ì£¼ì†Œ.ì£¼ì†Œ%>" />
          </div>
      
          <div class="container" style="background-color:#f1f1f1">
            <button type="button" onclick="document.getElementById('tu01').style.display='none'" class="cancelbtn">Cancel</button>
          </div>               
        </form>
      </div> 

    <script>
        // Get the modal
        var modal = document.getElementById('tu01');
            
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
            }

        const notification = document.getElementById('notification-container');
        
        function showNotification(){
            notification.classList.add('show')
            setTimeout(() => {
                notification.classList.remove('show')
                $("#notification-container").empty(); 
            }, 1500)   
        }        
    </script>    

    <script>
        
        var socket=io();//socket io   

        const pvideo = document.getElementById("peersvideo");//ìˆ˜ê°•ì í™”ë©´ì— ë³´ì—¬ì¤„ ê°•ì˜ì ìº”ë²„ìŠ¤ ìº¡ì³ì˜ìƒ
        const myvideo=document.getElementById('video');//ìº”ë²„ìŠ¤ ìº¡ì³ ìŠ¤íŠ¸ë¦¼ ì €ì¥
      
        const muteBtn = document.getElementById("mute");//ë§ˆì´í¬ ì˜¨ì˜¤í”„
        const startButton = document.getElementById('startButton');//í™”ë©´ê³µìœ  ë²„íŠ¼
        const sharevideo = document.getElementById('sharevideo');//í™”ë©´ ê³µìœ 
        

        var currentPeer=new Array();//peer ì ‘ì†ì ì£¼ì†Œ ì €ì¥í•  ë°°ì—´
        var screenSharing = false;

        let myStream;//ì‚¬ìš©ì ì˜¤ë””ì˜¤
        let myVideo;//ìº”ë²„ìŠ¤ ìº¡ì³ ìŠ¤íŠ¸ë¦¼ ì €ì¥
        let sendvideo;//ì°¸ì—¬ìë“¤ì—ê²Œ ë³´ë‚¼ ë¹„ë””ì˜¤,ì˜¤ë””ì˜¤ ìŠ¤íŠ¸ë¦¼
        let share;//í™”ë©´ê³µìœ  ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ì €ì¥
        let voice;//ì‚¬ìš©ì ì˜¤ë””ì˜¤íŠ¸ë™ ì¶”ì¶œ

        let muted=true;
        var id;//peer id

        muteBtn.addEventListener("click", handleMuteClick); 

    startMedia();//ì ‘ì†ì‹œ ê°•ì˜ìì™€ ìˆ˜ê°•ìê°€ í™”ë©´êµ¬ì„± hiddenìœ¼ë¡œ ì„¤ì •

    const myPeer=new Peer(undefined,{ //peer ì—°ê²° ì„¤ì • ìƒˆ í”¼ì–´ë¥¼ ë§Œë“¤
        secure:true,
        host:'teaching1901131.herokuapp.com',
        port:'443',
        path: "peerjs"
    });

    myPeer.on('open',function(id){//peer ì ‘ì†
        socket.emit('joinroom', '<%=ê¸€ë²ˆí˜¸%>',id); 
        socket.emit('user-send','<%=ì‚¬ìš©ì.nick%>ë‹˜ê»˜ì„œ ì ‘ì†í•˜ì˜€ìŠµë‹ˆë‹¤.');
        console.log('peer');
    }); 
  
    socket.on('count',function(data){//ì†Œìº£ì—ì„œ ì˜¨ ë°°ì—´ë¡œ ì ‘ì†ì ì¹´ìš´íŠ¸, ëª©ë¡ ì„¤ì •
        var list=new Array();
        for(var i=0;i<data.length; i++){
            if('<%=ê¸€ë²ˆí˜¸%>'==data[i]['room']){//ì†Œìº£ì— ì €ì¥ë˜ìˆëŠ” ë°© ì •ë³´ data ë°°ì—´ì—ì„œ ì ‘ì†í•œ ë°©ì˜ ì •ë³´ë¥¼ listì— ì €ì¥
                list.push({ socket:data[i]['socket']
                ,  room : String('<%=ê¸€ë²ˆí˜¸%>') 
                , user : data[i]['user']  
                })  
            }}
        
       document.getElementById('count').innerHTML='í˜„ì¬ ì°¸ì—¬ì ìˆ˜:'+list.length+'ëª…'; //ì´ ì°¸ì—¬ì ìˆ˜
       document.getElementById('count1').innerHTML='í˜„ì¬ ì°¸ì—¬ì ìˆ˜:'+list.length+'ëª…';
      
       $("#list *").remove(); 
       $("#list1 *").remove(); 

        for(var i=0;i<list.length;i++){
            $('#list').append('<div>' +list[i]['user']+'</div>'); //ì°¸ì—¬ì ë‹‰ë„¤ì„ ëª©ë¡
            $('#list1').append('<div>' +list[i]['user']+'</div>');
       }   
    });

    socket.on('bye',function(data){//ë°©ì—ì„œ ë‚˜ê°ˆ ì‹œ ì±„íŒ…ì°½ì— ë©”ì‹œì§€
        $('#chat').append('<div>' +data+'ë‹˜ê»˜ì„œ ë– ë‚˜ì…¨ìŠµë‹ˆë‹¤.'+'</div>');
    });      

    $('#send').click(function(){//ì±„íŒ… ë³´ë‚´ê¸° ë²„íŠ¼ í´ë¦­
    socket.emit('user-send','<%=ì‚¬ìš©ì.nick%>ë‹˜'+' : '+ $('#msg').val());
    });

    socket.on('broadcast', function(data) {//ì±„íŒ…ì°½ì— ì±„íŒ… ë³´ë‚¸ ë‚´ìš© ì¶”ê°€
    $('#chat').append('<div>' +data + '</div>');//ì±„íŒ…ì°½ì— ì¶”ê°€
    const $chatbox = $('#chatbox'); 
    $chatbox.scrollTop($chatbox[0].scrollHeight);//ìŠ¤í¬ë¡¤ ê°€ì¥ ì•„ë˜ë¡œ ë‚´ë¦¼
    });
 
    socket.on('exit',function(){
        console.log('ì´ë™');        
        location.replace('/board/<%=ê¸€ë²ˆí˜¸%>');
    });

    socket.on('alarm',function(data){
        $("#notification-container").append('<p>'+ 'ğŸ– '+data+'ë‹˜ì´ ì†ì„ ë“¤ì—ˆìŠµë‹ˆë‹¤.'+'</p>'); 
        //ì†ë“¤ê¸° ì•ŒëŒ
        showNotification();
    });

    $('#msg').keypress(function(event){
        if ( event.which == 13 ) {//ì±„íŒ…ë‚´ìš© ì…ë ¥ í›„ ì—”í„° ì‹œ ì±„íŒ… ë²„íŠ¼ í´ë¦­ê³¼ ê°™ì€ íš¨ê³¼
        $('#send').click();
        return false;
    }
    });

    $('i').click(function(e){
        if(e.target.dataset.icon=='img'){//ë¬¸ì œ ì´ë¯¸ì§€ ì•„ì´ì½˜ í´ë¦­
            document.getElementById('tu01').style.display='block'  //ëª¨ë‹¬ ë³´ì´ê¸°
        }
        else if(e.target.dataset.icon=='noti'){//ì†ë“¤ê¸° ì•„ì´ì½˜ ëª¨ë‹¬ í´ë¦­
            socket.emit('notifi','<%=ì‚¬ìš©ì.nick%>');           
        }                             
        });


    startButton.addEventListener('click', () => { //í™”ë©´ê³µìœ  í´ë¦­ ì‹œ
        sharevideo.hidden=false; //í™”ë©´ ê³µìœ  ë³´ì—¬ì¤„ ë¹„ë””ì˜¤ í™”ë©´ì— ë³´ì„
        cv.hidden=true;//ìº”ë²„ìŠ¤ ìˆ¨ê¸°ê¸°
        navigator.mediaDevices.getDisplayMedia({video: true})
            .then(handleSuccess, handleError);
        });

        if ((navigator.mediaDevices && 'getDisplayMedia' in navigator.mediaDevices)) {
        startButton.disabled = false;
        
        } else {
        errorMsg('getDisplayMedia is not supported');
        }

    async function getMedia() {//ì‚¬ìš©ì ì˜¤ë””ì˜¤ ê°€ì ¸ì˜¤ê¸°/ peer, socket ioë¡œ ë¯¸ë””ì–´ ë³´ë‚´ê¸°
    myvideo.muted = true;
        try {
            myStream = await navigator.mediaDevices.getUserMedia(
            {
                video:false,
                audio:true,//ì˜¤ë””ì˜¤ë§Œ ê°€ì ¸ì˜´
            })
                 
            voice=myStream.getAudioTracks();//ì˜¤ë””ì˜¤ íŠ¸ë™ ì¶”ì¶œ
            
        } catch (e) {
            console.log(e);
        }    
        
        const canvas = document.querySelector('canvas');
        const mediaStream = canvas.captureStream();//ìº”ë²„ìŠ¤ ìº¡ì³ ìŠ¤íŠ¸ë¦¼
        
        myVideo=mediaStream;     
        myvideo.srcObject = myVideo; //myvideo ë¹„ë””ì˜¤ì— ìº”ë²„ìŠ¤ ìŠ¤íŠ¸ë¦¼

        sendvideo=myvideo.srcObject; //ìº”ë²„ìŠ¤ ìŠ¤íŠ¸ë¦¼ ì˜ìƒ ë„£ê¸°
        sendvideo.addTrack(voice[0]); //ì¶”ì¶œí•œ ì˜¤ë””ì˜¤ ë„£ê¸°
        

        myPeer.on('call',function(call){//ì ‘ì†ìë“¤ì—ê²Œ ì‘ë‹µ
            console.log('answer');   
                    
            call.answer(sendvideo); 
            call.on('stream',function(userVideoStream){   
                const sharevoice=document.createElement('audio');//ì˜¤ë””ì˜¤ íƒœê·¸ ìƒì„±
                addaudio(sharevoice,userVideoStream);//ì‘ë‹µìë“¤ì˜ ì˜¤ë””ì˜¤ ì €ì¥
        });           
            
            currentPeer.push(call);//ì ‘ì†ë˜ì–´ ìˆëŠ” peeridì„ ë°°ì—´ì— ì €ì¥
            console.log(currentPeer);
        }); 


        socket.on('user-connected',function(userid){//ì ‘ì†ìë“¤ peer id ì—°ê²°
            console.log('ìœ ì €ì—°ê²°: '+userid);
            setTimeout(connectNewUser,1000,userid,sendvideo); //ì ‘ì†ìë“¤ì—ê²Œ ì˜ìƒ,ì˜¤ë””ì˜¤ ë³´ë‚´ê¸°
        });   
       
    }

    function connectNewUser(userid,stream){
        console.log('connet í•¨ìˆ˜');
        const call = myPeer.call(userid, stream);

        call.on('stream',function(userVideoStream){   
                        
              pvideo.srcObject=userVideoStream;  
              myvideo.srcObject=userVideoStream;

              const sharevoice2=document.createElement('audio'); //ì˜¤ë””ì˜¤ íƒœê·¸ ìƒì„±
              addaudio(sharevoice2,userVideoStream); //ì°¸ì—¬ì ì˜¤ë””ì˜¤ ì €ì¥     
            
        });
       
        currentPeer.push(call);//peerid ì €ì¥
        console.log(currentPeer);
    }


    function handleMuteClick() {  //ë§ˆì´í¬ ì¼œê¸° ë„ê¸° ë²„íŠ¼

        console.log(myStream.getAudioTracks());
        
        myStream.getAudioTracks().forEach((track) => track.enabled = !track.enabled);
        if(!muted) {
            
            muteBtn.innerText = "ë§ˆì´í¬ ë„ê¸°";
            muted = true;
        }
        else {
             
            muteBtn.innerText = "ë§ˆì´í¬ ì¼œê¸°";
            muted = false;               
        }
    }

    function handleSuccess(stream) {//í™”ë©´ ê³µìœ 
        startButton.disabled = true;
        sharevideo.srcObject = stream;
        share=stream;
    
        let videoTrack = share.getVideoTracks()[0];//í™”ë©´ê³µìœ  ë¹„ë””ì˜¤íŠ¸ë™

        currentPeer.forEach((Peer)=>{//peerì£¼ì†Œë§ˆë‹¤ senderë¥¼ í†µí•´ ìˆ˜ê°•ì í™”ë©´ì— sharevideoì— ë¹„ë””ì˜¤íŠ¸ë™ ì¶”ê°€
            let sender = Peer.peerConnection.getSenders().find(function (s) {
                return s.track.kind === videoTrack.kind;
            })  
            sender.replaceTrack(videoTrack);          
            console.log('ë°”ê¿ˆ');  
        });
            screenSharing = true;

        stream.getVideoTracks()[0].addEventListener('ended', () => {//í™”ë©´ê³µìœ  ì¤‘ì§€
            errorMsg('The user has ended sharing the screen');
            startButton.disabled = false;
            sharevideo.hidden=true;
            cv.hidden=false;

            if (!screenSharing) return;

            let videoTrack = sendvideo.getVideoTracks()[0];//ê°•ì˜ì ìº”ë²„ìŠ¤ ìº¡ì³ ë¹„ë””ì˜¤

            currentPeer.forEach((Peer)=>{
            let sender = Peer.peerConnection.getSenders().find(function (s) {
                return s.track.kind === videoTrack.kind;
            })  
            sender.replaceTrack(videoTrack);   
            });  
            screenSharing = false;
        });
        }

        function handleError(error) {
        errorMsg(`getDisplayMedia error: ${error.name}`, error);
        }
        function errorMsg(msg, error) {
        console.log(msg);
        if (typeof error !== 'undefined') {console.error(error);}
        }

    function startMedia(){//ì ‘ì†ì‹œ ì‚¬ìš©ìê°€ ê°•ì˜ìì¸ì§€ ìˆ˜ê°•ìì¸ì§€ êµ¬ë¶„í•˜ì—¬ í™”ë©´ ì„¸íŒ…
    if('<%=ì‚¬ìš©ì.nick%>'=='<%=ê°•ì˜ì%>'){
        sharevideo.hidden=true;
        myvideo.hidden=true;
        pvideo.hidden=true;  
        hand.hidden=true;
        listuser.hidden=true;
        $('#chat').append('<div>' +'ê°•ì˜ì í™”ë©´ì…ë‹ˆë‹¤.'+'</div>');

    }else{
        sharevideo.hidden=true;
        startButton.hidden=true;
        cv.hidden=true;
        exitbtn.hidden=true;
        myvideo.hidden=true;
    }
     getMedia();
    }

    function addaudio(audio,stream){//ì°¸ì—¬ìë“¤ ì˜¤ë””ì˜¤ ì¶”ê°€
        audio.srcObject=stream;
        console.log(audio.srcObject);
        audio.addEventListener('loadedmetadata', () => {
            audio.play();
        })
        $("#myStreamv").append(audio);
    }

    function exitmg(){
        socket.emit('user-send','ìˆ˜ì—…ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        socket.emit('done');
    }
    </script>
</body>
</html>